name: Simple Auto Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/**'

jobs:
  simple-release:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: ğŸ“¦ Restore and Build
      run: |
        dotnet restore ReturnOrderGenerator.csproj
        dotnet build ReturnOrderGenerator.csproj --configuration Release --no-restore

    - name: ğŸš€ Publish Application
      run: |
        dotnet publish ReturnOrderGenerator.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false -o ./release

    - name: ğŸ“… Generate Version and Package
      id: package
      run: |
        # ç”Ÿæˆç‰ˆæœ¬å·
        $timestamp = Get-Date -Format "yyyyMMdd-HHmm"
        $shortSha = "${{ github.sha }}".Substring(0, 7)
        $version = "auto-$timestamp-$shortSha"
        
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Generated version: $version"
        
        # åˆ›å»ºå‘å¸ƒåŒ…
        $packageName = "SF_P-$version-win-x64.zip"
        Compress-Archive -Path ./release/* -DestinationPath $packageName
        
        echo "package_name=$packageName" >> $env:GITHUB_OUTPUT
        echo "Created package: $packageName"
        
        # éªŒè¯æ–‡ä»¶
        if (Test-Path $packageName) {
            $size = (Get-Item $packageName).Length / 1MB
            echo "Package size: $([math]::Round($size, 2)) MB"
        } else {
            echo "Error: Package not created"
            exit 1
        }

    - name: ğŸ“ Create Release Notes
      id: notes
      run: |
        $version = "${{ steps.package.outputs.version }}"
        $commitMsg = git log -1 --pretty=format:"%s"
        $author = git log -1 --pretty=format:"%an"
        
        $notes = @"
        ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ $version
        
        ### ğŸ“‹ æ›´æ–°å†…å®¹
        **æäº¤ä¿¡æ¯**: $commitMsg  
        **æäº¤ä½œè€…**: $author
        
        ### ğŸ“¦ ä½¿ç”¨è¯´æ˜
        1. ä¸‹è½½ zip æ–‡ä»¶å¹¶è§£å‹
        2. åŒå‡» ``ReturnOrderGenerator.exe`` è¿è¡Œ
        3. æ— éœ€å®‰è£… .NET è¿è¡Œæ—¶
        
        ### â„¹ï¸ æ„å»ºä¿¡æ¯
        - æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        - æäº¤å“ˆå¸Œ: ${{ github.sha }}
        - ç³»ç»Ÿè¦æ±‚: Windows 10/11 (64ä½)
        "@
        
        $notes | Out-File -FilePath release-notes.txt -Encoding UTF8
        echo "notes_file=release-notes.txt" >> $env:GITHUB_OUTPUT

    - name: ğŸ‰ Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.package.outputs.version }}
        name: è‡ªåŠ¨æ„å»º ${{ steps.package.outputs.version }}
        body_path: ${{ steps.notes.outputs.notes_file }}
        files: ${{ steps.package.outputs.package_name }}
        draft: false
        prerelease: true
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: âœ… Success Notification
      run: |
        $version = "${{ steps.package.outputs.version }}"
        $packageName = "${{ steps.package.outputs.package_name }}"
        echo "ğŸ‰ å‘å¸ƒæˆåŠŸ!"
        echo "ç‰ˆæœ¬: $version"
        echo "æ–‡ä»¶: $packageName"
        echo "é“¾æ¥: https://github.com/mazongYY/SF_P/releases/tag/$version"